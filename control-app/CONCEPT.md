# aws data tier for meteor/mongo

* serve AWSsdk-compat SQS ans SNS (and S3 and IAM?) endpoints
* kubernetes oidc server auth (assumerolewithwebidentity from kubernetes SA token)
  * backend uses kubernetes.io claim to track what pod is taking actions
* use rbac system of kubernetes? like represent queues as Kinds and auth resource access with role bindings
* two tier backend design
  * meteor resource tier (control plane)
    * exposes DDP endpoint for resource discovery/management
    * serves realtime admin UI
      * UI connects directly to data tier on-demand when it wants actual messages
    * serves DDP stream of auth configuration - OIDC, rolebindings, etc
    * serves DDP stream of ongoing sessions - or iam sessionToken includes OIDC token
  * data tier (compat API) which talks XML/etc
    * service API (XML serializing) autogenerated from aws-sdk definitions
    * manage auth of connected clients
    * act as app compatibility layer, support vanilla awssdk simply with in-cluster endpoint URLs instead
    * long polling for new messages
    * connect directly to mongodb for messages
      * use changestreams, collection per queue, etc
      * optionally a meteor doesn't see the messages at all, UI connects directly to data tier on demand
* new programs could also connect directly to DDP endpoint to be streamed messages
  * subscribe to e.g. 10 messages, every delete can be responded to with a new message from the pile
  
